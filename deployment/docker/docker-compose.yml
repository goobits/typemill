version: '3.8'

services:
  mill:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      target: development
    container_name: mill-dev
    working_dir: /app/rust
    ports:
      - "3000:3000"  # WebSocket server
      - "4000:4000"  # Admin/health endpoints
    environment:
      - RUST_LOG=debug
      - TYPEMILL__SERVER__PORT=3000
      - TYPEMILL__SERVER__HOST=0.0.0.0
      - TYPEMILL__LOGGING__LEVEL=debug
      - TYPEMILL__LOGGING__FORMAT=pretty
    volumes:
      # Mount host source code for hot-reloading
      - ../rust:/app/rust
      # Mount local cargo registry to cache dependencies
      - cargo-registry:/usr/local/cargo/registry
      # Mount target directory to cache builds
      - rust-target:/app/rust/target
    restart: unless-stopped
    networks:
      - mill-net

  python-workspace:
    image: python:3.11-slim
    container_name: python-workspace
    depends_on:
      mill:
        condition: service_started
    networks:
      - mill-net
    volumes:
      - ./agent.py:/app/agent.py:ro
    expose:
      - "8000"
    command: >
      bash -c "
        echo 'Installing dependencies...' &&
        pip install -q aiohttp &&
        echo 'Starting agent...' &&
        python /app/agent.py &
        AGENT_PID=\$! &&
        echo \"Agent started with PID \$AGENT_PID\" &&
        sleep 2 &&
        echo 'Waiting for agent to be ready...' &&
        until curl -s --fail http://localhost:8000/health > /dev/null; do
          sleep 1;
        done;
        echo 'Agent is ready.' &&
        echo 'Waiting for TypeMill admin server...' &&
        until curl -s --fail http://mill-dev:4000/health > /dev/null; do
          sleep 1;
        done;
        echo 'TypeMill is healthy. Registering workspace...' &&
        curl -X POST http://mill-dev:4000/workspaces/register \
          -H 'Content-Type: application/json' \
          -d '{\"id\": \"python-workspace\", \"language\": \"python\", \"project_name\": \"Sample Python Project\", \"agent_url\": \"http://python-workspace:8000\"}' &&
        echo 'Workspace registered. Agent running...' &&
        wait \$AGENT_PID
      "

volumes:
  cargo-registry:
  rust-target:

networks:
  mill-net:
    driver: bridge
