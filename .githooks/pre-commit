#!/usr/bin/env bash
# Pre-commit hook to check for missing external parser artifacts
#
# Installation:
#   git config core.hooksPath .githooks
#
# Or copy to .git/hooks/:
#   cp .githooks/pre-commit .git/hooks/pre-commit

set -e

WORKSPACE_ROOT="$(git rev-parse --show-toplevel)"
cd "$WORKSPACE_ROOT"

# Colors
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m'

echo "üîç Checking external parser artifacts..."

missing_artifacts=()
warnings=()

# Check Java parser
JAVA_PARSER_JAR="crates/cb-lang-java/resources/java-parser/target/java-parser-1.0.0.jar"
if [ -f "crates/cb-lang-java/resources/java-parser/pom.xml" ]; then
    if [ ! -f "$JAVA_PARSER_JAR" ]; then
        missing_artifacts+=("Java parser JAR ($JAVA_PARSER_JAR)")
    fi
fi

# Check C# parser
CSHARP_PARSER_DIR="crates/cb-lang-csharp/resources/csharp-parser"
if [ -d "$CSHARP_PARSER_DIR" ]; then
    # Check for build output (platform-specific)
    if [ ! -d "$CSHARP_PARSER_DIR/bin/Release" ]; then
        missing_artifacts+=("C# parser build output ($CSHARP_PARSER_DIR/bin/Release/)")
    fi
fi

# Check TypeScript/JavaScript dependencies
TS_PARSER_DIR="crates/cb-lang-typescript/resources"
if [ -f "$TS_PARSER_DIR/package.json" ]; then
    if [ ! -d "$TS_PARSER_DIR/node_modules" ]; then
        missing_artifacts+=("TypeScript parser dependencies ($TS_PARSER_DIR/node_modules/)")
    fi
fi

# Check Swift parser (SourceKitten - optional)
if ! command -v sourcekitten >/dev/null 2>&1; then
    # Only warn if Swift plugin exists
    if [ -d "crates/cb-lang-swift" ]; then
        warnings+=("SourceKitten not installed (optional for Swift parser)")
    fi
fi

# Report findings
if [ ${#missing_artifacts[@]} -gt 0 ]; then
    echo ""
    echo -e "${RED}‚ùå Missing external parser artifacts:${NC}"
    for artifact in "${missing_artifacts[@]}"; do
        echo -e "   ${RED}‚Ä¢${NC} $artifact"
    done
    echo ""
    echo -e "${YELLOW}To build all parsers, run:${NC}"
    echo -e "   ${GREEN}make build-parsers${NC}"
    echo ""
    echo -e "${YELLOW}To check dependencies, run:${NC}"
    echo -e "   ${GREEN}make check-parser-deps${NC}"
    echo ""
    exit 1
fi

if [ ${#warnings[@]} -gt 0 ]; then
    echo ""
    echo -e "${YELLOW}‚ö†Ô∏è  Warnings:${NC}"
    for warning in "${warnings[@]}"; do
        echo -e "   ${YELLOW}‚Ä¢${NC} $warning"
    done
    echo ""
fi

echo -e "${GREEN}‚úÖ All required parser artifacts present${NC}"
exit 0
