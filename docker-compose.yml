# docker-compose.yml - CodeFlow Buddy Service Development Setup
version: '3.8'

services:
  # CodeFlow WebSocket Service
  codeflow-service:
    build:
      context: .
      dockerfile: Dockerfile.service
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=development
      - MAX_CLIENTS=20
      - LOG_LEVEL=debug
      - ENABLE_FUSE=true
    volumes:
      # Mount logs directory for persistence
      - ./logs:/app/logs
      # FUSE mount directories
      - /tmp/codeflow-workspaces:/tmp/codeflow-workspaces:shared
      - /tmp/codeflow-mounts:/tmp/codeflow-mounts:shared
    devices:
      # Required for FUSE operations
      - /dev/fuse:/dev/fuse
    cap_add:
      # Required capabilities for FUSE
      - SYS_ADMIN
    security_opt:
      # Allow access to FUSE devices
      - apparmor:unconfined
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    networks:
      - codeflow-network

  # Frontend Development Container (Node.js/React example)
  frontend-dev:
    image: node:20
    working_dir: /workspace
    volumes:
      - ./examples/frontend:/workspace
      - frontend-node-modules:/workspace/node_modules
    environment:
      - MCP_SERVER=ws://codeflow-service:3000
      - PROJECT_ID=frontend-app
      - PROJECT_ROOT=/workspace
    command: >
      sh -c "
        echo 'Setting up frontend development environment...' &&
        npm install &&
        echo 'Frontend container ready. Connect to CodeFlow service at ws://codeflow-service:3000' &&
        tail -f /dev/null
      "
    depends_on:
      codeflow-service:
        condition: service_healthy
    networks:
      - codeflow-network

  # Backend Development Container (Python/FastAPI example)
  backend-dev:
    image: python:3.11-slim
    working_dir: /workspace
    volumes:
      - ./examples/backend:/workspace
    environment:
      - MCP_SERVER=ws://codeflow-service:3000
      - PROJECT_ID=backend-api
      - PROJECT_ROOT=/workspace
      - PYTHONPATH=/workspace
    command: >
      sh -c "
        echo 'Setting up backend development environment...' &&
        pip install -r requirements.txt 2>/dev/null || echo 'No requirements.txt found' &&
        echo 'Backend container ready. Connect to CodeFlow service at ws://codeflow-service:3000' &&
        tail -f /dev/null
      "
    depends_on:
      codeflow-service:
        condition: service_healthy
    networks:
      - codeflow-network

  # Database Development Container (PostgreSQL example)
  postgres-dev:
    image: postgres:15-alpine
    environment:
      - POSTGRES_DB=devdb
      - POSTGRES_USER=devuser
      - POSTGRES_PASSWORD=devpass
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./examples/database/init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "5432:5432"
    networks:
      - codeflow-network

volumes:
  frontend-node-modules:
  postgres-data:

networks:
  codeflow-network:
    driver: bridge